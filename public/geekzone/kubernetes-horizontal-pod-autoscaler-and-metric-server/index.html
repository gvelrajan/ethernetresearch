<!doctype html>

<html lang="en">

<head>
  <title>Kubernetes Horizontal Pod Autoscaler and Metric Server - Ethernet Research</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Ethernet Research: Actionable information about cloud technologies at your fingertips " />
<meta name="author" content="Ganesh Velrajan" /><meta property="og:title" content="Kubernetes Horizontal Pod Autoscaler and Metric Server" />
<meta property="og:description" content="What is Horizontal Pod Autoscaler(HPA) The Horizontal Pod Autoscaler automatically scales up or scales down the number of pods in a deployment based on some metric such as CPU usage or some other custom metric." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.ethernetresearch.com/geekzone/kubernetes-horizontal-pod-autoscaler-and-metric-server/" />
<meta property="og:image" content="http://www.ethernetresearch.com/images/kubernetes/kubernetes.jpg" />
<meta property="article:published_time" content="2018-10-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-10-24T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://www.ethernetresearch.com/images/kubernetes/kubernetes.jpg"/>

<meta name="twitter:title" content="Kubernetes Horizontal Pod Autoscaler and Metric Server"/>
<meta name="twitter:description" content="What is Horizontal Pod Autoscaler(HPA) The Horizontal Pod Autoscaler automatically scales up or scales down the number of pods in a deployment based on some metric such as CPU usage or some other custom metric."/>

<meta name="generator" content="Hugo 0.72.0" />
    

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <link rel="stylesheet" href="http://www.ethernetresearch.com/fontawesome/css/all.min.css" />
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  
  
  <link rel="stylesheet" type="text/css" href="http://www.ethernetresearch.com/css/styles.css" /></head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="http://www.ethernetresearch.com/">Ethernet Research</a>
            </h1>

      <ul id="social-media">
             <li>
               <a href="https://linkedin.com/in/username" title="LinkedIn">
               <i class="fab fa-linkedin fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://www.youtube.com/channel/UCnmHCstjZcevizOQ0qmANlw" title="Youtube">
               <i class="fab fa-youtube fa-lg"></i>
               </a>
             </li>
      </ul>
      
      <p><em>Actionable information about cloud technologies</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="http://www.ethernetresearch.com/geekzone/">
                <i class="fa-li fa  fa-lg"></i><span>GeekZone</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://www.ethernetresearch.com/articles/">
                <i class="fa-li fa  fa-lg"></i><span>Articles</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://www.ethernetresearch.com/about/">
                <i class="fa-li fa  fa-lg"></i><span>About Us</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://www.ethernetresearch.com/online-courses-training/">
                <i class="fa-li fa  fa-lg"></i><span>Online Courses</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://www.ethernetresearch.com/contact/">
                <i class="fa-li fa  fa-lg"></i><span>Contact</span>
            </a>
        </li>
        
    </ul>
</nav>


    <main>




<article>

    <h1>Kubernetes Horizontal Pod Autoscaler and Metric Server</h1>

    
      <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2018-10-24T00:00:00Z">Oct 24, 2018</time>
        </li>
        
        
        <li>
            Categories:
            <em>
                
                    
                    <a href="http://www.ethernetresearch.com/categories/geekzone">GeekZone</a>
                
                    , 
                    <a href="http://www.ethernetresearch.com/categories/kubernetes">Kubernetes</a>
                
            </em>
        </li>
        

        
        <li>
            <em>
                
                    
                    <a href="http://www.ethernetresearch.com/tags/container">#Container</a>
                
                    , 
                    <a href="http://www.ethernetresearch.com/tags/docker">#Docker</a>
                
                    , 
                    <a href="http://www.ethernetresearch.com/tags/kubernetes">#Kubernetes</a>
                
            </em>
        </li>
        

        <li>6 minute read</li>
    </ul>
</aside>

    

    
<div class="featured_image">
    <a href="http://www.ethernetresearch.com/geekzone/kubernetes-horizontal-pod-autoscaler-and-metric-server/" title="Kubernetes Horizontal Pod Autoscaler and Metric Server">
        <img src="http://www.ethernetresearch.com/images/kubernetes/kubernetes.jpg">
    </a>
</div>



    <h2 id="what-is-horizontal-pod-autoscalerhpa">What is Horizontal Pod Autoscaler(HPA)</h2>
<p>The Horizontal Pod Autoscaler automatically scales up or scales down the number of pods in a deployment based on some metric such as CPU usage or some other custom metric.</p>
<p>Here is a <strong>formal definition</strong> from the Kubernetes Official Documentation:</p>
<p>&ldquo;The Horizontal Pod Autoscaler automatically scales the number of pods in a replication controller, deployment or replica set based on observed CPU utilization (or, with <a href="https://git.k8s.io/community/contributors/design-proposals/instrumentation/custom-metrics-api.md">custom metrics</a> support, on some other application-provided metrics). Note that Horizontal Pod Autoscaling does not apply to objects that can’t be scaled, for example, DaemonSets.</p>
<p>The Horizontal Pod Autoscaler is implemented as a Kubernetes API resource and a controller. The resource determines the behavior of the controller. The controller periodically adjusts the number of replicas in a replication controller or deployment to match the observed average CPU utilization to the target specified by user.&rdquo;</p>
<p><img src="http://www.thetechzone.in/wp-content/uploads/2018/09/Screen-Shot-2018-09-28-at-8.24.06-AM-300x252.jpg" alt="Kubernetes Horizontal Pod Autoscaler and metric-server">{.alignnone .wp-image-43 width=&quot;464&rdquo; height=&quot;390&rdquo;}</p>
<p>In this article, we&rsquo;ll configure HPA to use the CPU utilization as a metric to automatically scale up or scale down pods in a deployment using Minikube.</p>
<h2 id="metric-server">Metric-Server:</h2>
<p>Metric-Server collects the resource utilization such as CPU or Memory utilization across the cluster.  It provides a metrics API through which other agents, such as the <em>&ldquo;kubectl top</em> &ldquo;command,  HPA, and even the users,  could fetch the resource utilization information to make various decisions.</p>
<h3 id="installing-and-configuring-metric-server-and-hpa-in-the-cluster">Installing and Configuring Metric-Server and HPA in the cluster</h3>
<p>In this demo, I&rsquo;ll use a  single node Minikube Cluster running in a VM in Google Cloud Platform to demonstrate the power of Horizontal Pod Autoscaler.</p>
<p>Following the instructions in this article to <a href="http://www.ethernetresearch.com/kubernetes/kubernetes-how-to-install-minikube-in-a-vm/">install Minikube in a VM or Laptop</a></p>
<p>If you are planning to implement HPA autoscaler using Kubernetes Cluster, then follow the procedure in this <a href="https://kubernetes.io/docs/tasks/debug-application-cluster/core-metrics-pipeline/">documentation on Core Metric Pipeline</a> to install the metric-server.</p>
<h4 id="step-1">Step #1:</h4>
<p>Enable the metric-server in the Minikube cluster.  You need to install the following command as a root user.</p>
<pre><code>gannygans@minikube:~$ sudo minikube addons enable metrics-server
metrics-server was successfully enabled
</code></pre>
<h4 id="step2">Step#2:</h4>
<p>Create a deployment with 1 pod using the below deployment YAML file.  We&rsquo;ll use the <em>gvelrajan/hello-world:v2.0</em> application from my public docker hub registry.</p>
<p>The pod runs a simple nodejs helloworld web server application that prints &ldquo;Hello World!&rdquo; on the browser when connected to the web server.</p>
<pre><code>gannygans@minikube:~$ cat deployment.yaml 
apiVersion: extensions/v1beta1
kind: Deployment                                          # 1
metadata:
  name: helloworld
spec:
  replicas: 1                                             # 2
  minReadySeconds: 15
  strategy:
    type: RollingUpdate                                   # 3
    rollingUpdate: 
      maxUnavailable: 1                                   # 4
      maxSurge: 1                                         # 5
  template:                                               # 6
    metadata:
      labels:
        app: helloworld                                   # 7
    spec:
      containers:
        - image: gvelrajan/hello-world:v2.0 
          imagePullPolicy: Always                         # 8
          name: helloworld 
          ports:
            - containerPort: 80
          resources:
            requests:
              cpu: 200m

gannygans@minikube:~$ kubectl get pods
No resources found.
gannygans@minikube:~$ kubectl get deployment
No resources found.
gannygans@minikube:~$ kubectl create -f deployment.yaml
deployment.extensions/helloworld created

gannygans@minikube:~$ kubectl get pods
NAME READY STATUS RESTARTS AGE
helloworld-5cd647f57c-z9s87 1/1 Running 0 2m
</code></pre>
<h4 id="step-3">Step #3:</h4>
<p>Let&rsquo;s create a load balancer service named &ldquo;<em>helloworld-lb</em>&rdquo; using the below service YAML.</p>
<pre><code>gannygans@minikube:~$ cat service.yaml
apiVersion: v1
kind: Service              # 1
metadata:
  name: helloworld-lb
spec:
  externalIPs:
  - 10.160.0.3
  type: LoadBalancer       # 2
  ports:
  - port: 80               # 3
    protocol: TCP          # 4
    targetPort: 80         # 5
  selector:                # 6
    app: helloworld        # 7

gannygans@minikube:~$ kubectl get service
NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE
helloworld-lb LoadBalancer 10.110.45.50 10.160.0.3 80:32741/TCP 3h
kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 15d
</code></pre>
<h3 id="configure-the-autoscaler">Configure the Autoscaler:</h3>
<p>Now, let&rsquo;s configure an Autoscaler for the deployment we have created.</p>
<p>We want the autoscaler to automatically spin-up a new pod in the deployment, when the CPU utilization goes above 2%.</p>
<p>And similarly, if the CPU utilization goes below 2%, we want the Autoscaler to automatically bring down a pod.</p>
<p>We  want autoscaler to always run atleast 1 pod even when the CPU utilization is 0%.</p>
<p>At the maximum, it can scale the number of pods to 10.</p>
<p>It is a good security practice to set the max limit on the pods, when configuring autoscaler.</p>
<p>If we don&rsquo;t specify the maximum number, the autoscaler could be attacked by a DoS attacker to spin up unlimited number of pods and consume all the resources available in the cluster, making the other applications running in the same cluster to starve for resources.</p>
<pre><code>gannygans@minikube:~$ kubectl autoscale deployment helloworld --cpu-percent=2 --min=1 --max=10
horizontalpodautoscaler.autoscaling/helloworld autoscaled
gannygans@minikube:~$
</code></pre>
<p>Now check the status of the Horizontal Pod Scaler for our deployment.</p>
<pre><code>gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld &lt;unknown&gt;/2% 1 10 0 18s
gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld &lt;unknown&gt;/2% 1 10 0 26s
gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld 0%/2% 1 10 1 1m
</code></pre>
<p><strong>Note</strong>: It may take few minutes for the HPA to collect the metrics from the metric-server.  HPA  doesn&rsquo;t poll the metric-server too often.  It polls metric-server only every minute.</p>
<h3 id="automatic-pod-scale-up-and-scale-down-demo">Automatic Pod Scale Up and Scale Down Demo</h3>
<p>Crank up the CPU usage by repeatedly polling the web-interface in a loop using  a shell script.</p>
<pre><code>$cat test.sh
for var in {1..10000} 
do 
      curl http://35.200.250.14/ 
      echo &quot;\n&quot;
done
$

$sh test.sh
Hello World!

Hello World!

Hello World!

Hello World!

Hello World!

Hello World!

Hello World!

Hello World!

...

...
</code></pre>
<p><strong>Note</strong>: It may take few minutes for the HPA to detect and begin taking any action.</p>
<pre><code>gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld 2%/2% 1 10 1 4m


gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld 12%/2% 1 10 1 4m


gannygans@minikube:~$ kubectl get pods
NAME READY STATUS RESTARTS AGE
helloworld-5cd647f57c-bstxl 1/1 Running 0 23s
helloworld-5cd647f57c-djxn5 1/1 Running 0 23s
helloworld-5cd647f57c-l7v94 1/1 Running 0 23s
helloworld-5cd647f57c-z9s87 1/1 Running 0 7m
gannygans@minikube:~$

gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld 2%/2% 1 10 4 7m
</code></pre>
<p>Now, let&rsquo;s kill the script to bring down the CPU utilization.</p>
<pre><code>...

...

Hello World!

Hello World!

Hello World!

^C
$
$
</code></pre>
<p>Check if the autoscaler detects the drop in CPU utilization and starts to bring down the pods one by one, slowly.</p>
<p><strong>Note</strong>: It may take few minutes for the HPA to detect and begin taking any action.</p>
<pre><code>gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld 9%/2% 1 10 4 5m
gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld 3%/2% 1 10 4 6m
gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld 3%/2% 1 10 4 6m
gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld 2%/2% 1 10 4 7m
gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld 2%/2% 1 10 4 7m
gannygans@minikube:~$

gannygans@minikube:~$ kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
helloworld Deployment/helloworld 0%/2% 1 10 4 9m
gannygans@minikube:~$ kubectl get pods
NAME READY STATUS RESTARTS AGE
helloworld-5cd647f57c-bstxl 1/1 Terminating 0 5m
helloworld-5cd647f57c-djxn5 1/1 Terminating 0 5m
helloworld-5cd647f57c-l7v94 1/1 Terminating 0 5m
helloworld-5cd647f57c-z9s87 1/1 Running 0 12m

gannygans@minikube:~$ kubectl get pods
NAME READY STATUS RESTARTS AGE
helloworld-5cd647f57c-z9s87 1/1 Running 0 13m
gannygans@minikube:~$
</code></pre>
<p>Now to delete the HPA autoscaler, using the delete command.</p>
<pre><code>gannygans@minikube:~$ kubectl delete hpa helloworld
horizontalpodautoscaler.autoscaling &quot;helloworld&quot; deleted
</code></pre>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="http://www.ethernetresearch.com/geekzone/docker-tutorial-persistent-storage-volumes-and-stateful-containers/"><i class="fa fa-chevron-circle-left"></i> Docker Containers Tutorial - Persistent Storage Volumes and Stateful Containers</a>
        </li>
        
        
        <li>
            <a href="http://www.ethernetresearch.com/geekzone/kubernetes-dashboard-setup-and-login/">Kubernetes Dashboard Setup and Login <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
  
    
    
  





</main>
    <footer>
        <h6>Copyright © 2021 - Ethernet Research | All Rights Reserved.</h6>
    </footer>
</div>
<script src="http://www.ethernetresearch.com/js/scripts.js"></script>


</body>

</html>

