<!doctype html>

<html lang="en">

<head>
  <title>Docker Containers Tutorial - Persistent Storage Volumes and Stateful Containers - Ethernet Research</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Ethernet Research: Actionable information about cloud technologies at your fingertips " />
<meta name="author" content="Ganesh Velrajan" /><meta property="og:title" content="Docker Containers Tutorial - Persistent Storage Volumes and Stateful Containers" />
<meta property="og:description" content="In this article, I&rsquo;ll show you how to mount persistent storage volumes inside a Docker container, so that Stateful Applications such as MySQL or MongoDB or PostgreSQL could be run as Docker Containers." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.ethernetresearch.com/geekzone/docker-tutorial-persistent-storage-volumes-and-stateful-containers/" />
<meta property="og:image" content="http://www.ethernetresearch.com/images/docker/docker.png" />
<meta property="article:published_time" content="2018-10-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-10-23T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://www.ethernetresearch.com/images/docker/docker.png"/>

<meta name="twitter:title" content="Docker Containers Tutorial - Persistent Storage Volumes and Stateful Containers"/>
<meta name="twitter:description" content="In this article, I&rsquo;ll show you how to mount persistent storage volumes inside a Docker container, so that Stateful Applications such as MySQL or MongoDB or PostgreSQL could be run as Docker Containers."/>

<meta name="generator" content="Hugo 0.72.0" />
    

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <link rel="stylesheet" href="http://www.ethernetresearch.com/fontawesome/css/all.min.css" />
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  
  
  <link rel="stylesheet" type="text/css" href="http://www.ethernetresearch.com/css/styles.css" /></head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="http://www.ethernetresearch.com/">Ethernet Research</a>
            </h1>

      <ul id="social-media">
             <li>
               <a href="https://linkedin.com/in/username" title="LinkedIn">
               <i class="fab fa-linkedin fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://www.youtube.com/channel/UCnmHCstjZcevizOQ0qmANlw" title="Youtube">
               <i class="fab fa-youtube fa-lg"></i>
               </a>
             </li>
      </ul>
      
      <p><em>Actionable information about cloud technologies</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="http://www.ethernetresearch.com/geekzone/">
                <i class="fa-li fa  fa-lg"></i><span>GeekZone</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://www.ethernetresearch.com/articles/">
                <i class="fa-li fa  fa-lg"></i><span>Articles</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://www.ethernetresearch.com/about/">
                <i class="fa-li fa  fa-lg"></i><span>About Us</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://www.ethernetresearch.com/online-courses-training/">
                <i class="fa-li fa  fa-lg"></i><span>Online Courses</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://www.ethernetresearch.com/contact/">
                <i class="fa-li fa  fa-lg"></i><span>Contact</span>
            </a>
        </li>
        
    </ul>
</nav>


    <main>




<article>

    <h1>Docker Containers Tutorial - Persistent Storage Volumes and Stateful Containers</h1>

    
      <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2018-10-23T00:00:00Z">Oct 23, 2018</time>
        </li>
        
        
        <li>
            Categories:
            <em>
                
                    
                    <a href="http://www.ethernetresearch.com/categories/geekzone">GeekZone</a>
                
                    , 
                    <a href="http://www.ethernetresearch.com/categories/docker">Docker</a>
                
            </em>
        </li>
        

        
        <li>
            <em>
                
                    
                    <a href="http://www.ethernetresearch.com/tags/geekzone">#GeekZone</a>
                
                    , 
                    <a href="http://www.ethernetresearch.com/tags/docker">#Docker</a>
                
                    , 
                    <a href="http://www.ethernetresearch.com/tags/kubernetes">#Kubernetes</a>
                
                    , 
                    <a href="http://www.ethernetresearch.com/tags/persistent-storage-volume">#Persistent Storage Volume</a>
                
            </em>
        </li>
        

        <li>7 minute read</li>
    </ul>
</aside>

    

    
<div class="featured_image">
    <a href="http://www.ethernetresearch.com/geekzone/docker-tutorial-persistent-storage-volumes-and-stateful-containers/" title="Docker Containers Tutorial - Persistent Storage Volumes and Stateful Containers">
        <img src="http://www.ethernetresearch.com/images/docker/docker.png">
    </a>
</div>



    <p>In this article, I&rsquo;ll show you how to mount persistent storage volumes inside a Docker container, so that Stateful Applications such as MySQL or MongoDB or PostgreSQL could be run as Docker Containers. We&rsquo;ll use MySQL as an example here.</p>
<h2 id="why-use-persistent-storage-volumes">Why use Persistent Storage Volumes?</h2>
<p>Containers are ephemeral in nature.  They have a filesystem of their own.  When containers die, the data stored locally in their filesystem is also gone.  Stateful applications such as MySQL or MongoDB or PostgreSQL cannot be run as Docker Containers, because the data stored in their database will be lost when the container crashes or dies or gets deleted.  Data is critical.  We don&rsquo;t want to lose it at any cost.</p>
<h2 id="what-is-a-persistent-storage-volume-">What is a Persistent Storage Volume ?</h2>
<p>A storage device or volume that can persist a container crash or its life cycle is called a Persistent Storage Volume.   Persistent storage volumes can be created in a disk mounted to the Host Machine directly or it could be created in a NAS storage device in the Local LAN network mounted as a network storage device on the Host Machine or it could even be created in a a cloud storage device mounted as a storage device in the Host Machine.</p>
<h2 id="how-to-create-persistent-storage-volumes---two-methods">How to create Persistent Storage Volumes - Two Methods:</h2>
<p>There are two different methods to mount a persistent storage volume inside a Docker Container.</p>
<p><strong>Method #1:</strong></p>
<p>You can create a new persistent storage volume in the Host Machine and mount it under a directory or folder inside a Docker Container.  The Docker Container gets exclusive access to the storage volume.   The data stored in the volume cannot be easily read, manipulated or corrupted from the Host Machine ( although, we could read the data through some means, I&rsquo;ll show you how, later in this article).</p>
<p><strong>Method #2:</strong></p>
<p>You can mount a local directory in the host machine as a persistent storage volume inside a Docker Container, so that data could be shared between the host machine and Docker Container.  This method is very useful if the host machine wants to access or periodically backup the data or database written to the  folder by the DB server running inside the Docker Container.</p>
<p><strong>Demo:</strong></p>
<h3 id="method-1">Method #1</h3>
<p>Check if there are any existing volumes:</p>
<pre><code>$ docker volume ls

DRIVER VOLUME NAME

$
</code></pre>
<p>Create a new persistent storage volume in the Host Machine</p>
<pre><code>$ docker volume create mysql-data

mysql-data

$ docker volume ls

DRIVER VOLUME NAME

local mysql-data

$
</code></pre>
<p>Inspect the storage volume to get more detailed information.</p>
<pre><code>$ docker volume inspect mysql-data
[
   {
      &quot;CreatedAt&quot;: &quot;2018-10-23T03:18:12Z&quot;,
      &quot;Driver&quot;: &quot;local&quot;,
      &quot;Labels&quot;: {},
      &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/mysql-data/_data&quot;, 
      &quot;Name&quot;: &quot;mysql-data&quot;,
      &quot;Options&quot;: {},
      &quot;Scope&quot;: &quot;local&quot;
   }
]
</code></pre>
<p>Check the data in the storage volume, from where it is mounted locally.  You need root privileges to access the folder where it is mounted in the host machine.</p>
<pre><code>$ ls /var/lib/docker/volumes/mysql-data/_data
ls: cannot access '/var/lib/docker/volumes/mysql-data/_data': 
Permission denied
$ sudo ls /var/lib/docker/volumes/mysql-data/_data
$
</code></pre>
<p>It is an empty volume with no data, as we expected.</p>
<p>Create a MySQL DB  (stateful) Docker Container and make it use the persistent storage volume we just created.  So that, MySQL will store its DB and files in this volume.  MySQL stores its data at the /var/lib/mysql folder.</p>
<pre><code>$ docker run --name ganesh-mysql -v mysql-data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=mypasswd -d mysql:latest

Unable to find image 'mysql:latest' locally
latest: Pulling from library/mysql
f17d81b4b692: Pull complete 
c691115e6ae9: Pull complete 
41544cb19235: Pull complete 
254d04f5f66d: Pull complete 
4fe240edfdc9: Pull complete 
0cd4fcc94b67: Pull complete 
8df36ec4b34a: Pull complete 
739800af3a9f: Pull complete 
0cbc995daddd: Pull complete 
5db5c83b9b9a: Pull complete 
9cb56d3f0a7e: Pull complete 
448d4de73cac: Pull complete 
Digest: sha256:8fdc47e9ccb8112a62148032ae70484e3453b628ab6fe02bccf159e2966b
750e
Status: Downloaded newer image for mysql:latest
e15c04f42ec6e5b0e0ae2256caf0f6ed4760c8f27806f300f9246bd0718dbe37
$
</code></pre>
<p>Now, get into the MySQL Docker Container&rsquo;s bash shell and check the /var/lib/mysql folder.</p>
<pre><code>$ docker exec -it e15c /bin/bash
root@e15c04f42ec6:/# ls
bin docker-entrypoint-initdb.d home media proc sbin tmp
boot entrypoint.sh lib mnt root srv usr
dev etc lib64 opt run sys var

root@e15c04f42ec6:/# ls /var/lib/mysql
auto.cnf ca.pem ib_logfile1 performance_schema sys
binlog.000001 client-cert.pem ibdata1 private_key.pem undo_001
binlog.000002 client-key.pem ibtmp1 public_key.pem undo_002
binlog.index ib_buffer_pool mysql server-cert.pem
ca-key.pem ib_logfile0 mysql.ibd server-key.pem

root@e15c04f42ec6:/# exit
exit
$
</code></pre>
<p>The folder has the mysql database and files.</p>
<p>Now let&rsquo;s check the same from the host machine&rsquo;s mount point folder.</p>
<pre><code>$ sudo ls /var/lib/docker/volumes/mysql-data/_data
auto.cnf ca.pem ib_logfile0 performance_schema sys
binlog.000001 client-cert.pem ib_logfile1 private_key.pem undo_001
binlog.000002 client-key.pem ibtmp1 public_key.pem undo_002
binlog.index ib_buffer_pool mysql server-cert.pem
ca-key.pem ibdata1 mysql.ibd server-key.pem
$
</code></pre>
<p>They reflect the same information.  This is because it&rsquo;s a volume created in the host namespace and mounted inside the container.</p>
<p>Now, if we kill and create a new MySQL docker container, it can reuse the MySQL database created by the previous incarnation, as it is.  That&rsquo;s the power of persistent storage volumes.  They persist a container crash or death.</p>
<pre><code>$ docker ps
CONTAINER ID IMAGE COMMAND CREATED 
STATUS PORTS NAMES
e15c04f42ec6 mysql:latest &quot;docker-entrypoint.s…&quot; 10 minutes
ago Up 10 minutes 3306/tcp, 33060/tcp ganesh-mysql

$ docker container stop ganesh-mysql
ganesh-mysql
$ docker container rm ganesh-mysql
ganesh-mysql

$ docker container ps -a
CONTAINER ID IMAGE COMMAND CREATED 
STATUS PORTS NAMES
$
</code></pre>
<p>Let&rsquo;s get the timestamp and snapshot of the files in the mysql-data storage volume we created.</p>
<pre><code>$ sudo ls -l /var/lib/docker/volumes/mysql-data/_data
total 179200
-rw-r----- 1 999 docker 56 Oct 23 03:31 auto.cnf
-rw-r----- 1 999 docker 3071644 Oct 23 03:31 binlog.000001
-rw-r----- 1 999 docker 178 Oct 23 03:42 binlog.000002
-rw-r----- 1 999 docker 155 Oct 23 03:44 binlog.000003
-rw-r----- 1 999 docker 48 Oct 23 03:44 binlog.index
-rw------- 1 999 docker 1680 Oct 23 03:31 ca-key.pem
-rw-r--r-- 1 999 docker 1112 Oct 23 03:31 ca.pem
-rw-r--r-- 1 999 docker 1112 Oct 23 03:31 client-cert.pem
-rw------- 1 999 docker 1680 Oct 23 03:31 client-key.pem
-rw-r----- 1 999 docker 4953 Oct 23 03:42 ib_buffer_pool
-rw-r----- 1 999 docker 12582912 Oct 23 03:44 ibdata1
-rw-r----- 1 999 docker 50331648 Oct 23 03:44 ib_logfile0
-rw-r----- 1 999 docker 50331648 Oct 23 03:30 ib_logfile1
-rw-r----- 1 999 docker 12582912 Oct 23 03:44 ibtmp1
drwxr-x--- 2 999 docker 4096 Oct 23 03:31 mysql
-rw-r----- 1 999 docker 31457280 Oct 23 03:44 mysql.ibd
drwxr-x--- 2 999 docker 4096 Oct 23 03:31 performance_schema
-rw------- 1 999 docker 1676 Oct 23 03:31 private_key.pem
-rw-r--r-- 1 999 docker 452 Oct 23 03:31 public_key.pem
-rw-r--r-- 1 999 docker 1112 Oct 23 03:31 server-cert.pem
-rw------- 1 999 docker 1680 Oct 23 03:31 server-key.pem
drwxr-x--- 2 999 docker 4096 Oct 23 03:31 sys
-rw-r----- 1 999 docker 12582912 Oct 23 03:44 undo_001
-rw-r----- 1 999 docker 10485760 Oct 23 03:44 undo_002
</code></pre>
<p>Now create a new MySQL Docker Container and make it use the same storage volume where MySQL DB and files already exists.</p>
<pre><code>$ docker run --name ganesh-mysql-v2 -v mysql-data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=mypasswd -d mysql:latest
46973aa2cddb3b65c94ec37bdee3e8b044767aa4ccc0962900e712eefd4710ec
$

$ sudo ls -l /var/lib/docker/volumes/mysql-data/_data
total 179200
-rw-r----- 1 999 docker 56 Oct 23 03:31 auto.cnf
-rw-r----- 1 999 docker 3071644 Oct 23 03:31 binlog.000001
-rw-r----- 1 999 docker 178 Oct 23 03:42 binlog.000002
-rw-r----- 1 999 docker 155 Oct 23 03:44 binlog.000003
-rw-r----- 1 999 docker 48 Oct 23 03:44 binlog.index
-rw------- 1 999 docker 1680 Oct 23 03:31 ca-key.pem
-rw-r--r-- 1 999 docker 1112 Oct 23 03:31 ca.pem
-rw-r--r-- 1 999 docker 1112 Oct 23 03:31 client-cert.pem
-rw------- 1 999 docker 1680 Oct 23 03:31 client-key.pem
-rw-r----- 1 999 docker 4953 Oct 23 03:42 ib_buffer_pool
-rw-r----- 1 999 docker 12582912 Oct 23 03:44 ibdata1
-rw-r----- 1 999 docker 50331648 Oct 23 03:44 ib_logfile0
-rw-r----- 1 999 docker 50331648 Oct 23 03:30 ib_logfile1
-rw-r----- 1 999 docker 12582912 Oct 23 03:44 ibtmp1
drwxr-x--- 2 999 docker 4096 Oct 23 03:31 mysql
-rw-r----- 1 999 docker 31457280 Oct 23 03:44 mysql.ibd
drwxr-x--- 2 999 docker 4096 Oct 23 03:31 performance_schema
-rw------- 1 999 docker 1676 Oct 23 03:31 private_key.pem
-rw-r--r-- 1 999 docker 452 Oct 23 03:31 public_key.pem
-rw-r--r-- 1 999 docker 1112 Oct 23 03:31 server-cert.pem
-rw------- 1 999 docker 1680 Oct 23 03:31 server-key.pem
drwxr-x--- 2 999 docker 4096 Oct 23 03:31 sys
-rw-r----- 1 999 docker 12582912 Oct 23 03:44 undo_001
-rw-r----- 1 999 docker 10485760 Oct 23 03:44 undo_002
</code></pre>
<p>We see that the files and their timestamp has not changed.  This proves that the new MySQL instances reused the database and files at /var/lib/mysql.  It also proves that the data is persistent across a container crash.</p>
<p> </p>
<h3 id="method-2">Method #2:</h3>
<p>First, let&rsquo;s create a directory in the host machine.</p>
<pre><code>$ mkdir mysql-data-dir
$ ls mysql-data-dir/
$
</code></pre>
<p>Now share the directory in the host-machine with the MySQL Docker Container.</p>
<pre><code>$ docker run --name ganesh-mysql-v3   
</code></pre>
<p>-v /home/user/mysql-data-dir:/var/lib/mysql<br>
-e MYSQL_ROOT_PASSWORD=mypasswd -d mysql:latest
a809f1fa7608714641148a47889d53894a60e9ead2f21b177d411dc7197da21a</p>
<pre><code>$ ls /home/user/mysql-data-dir
auto.cnf client-cert.pem ib_logfile1 private_key.pem undo_001
binlog.000001 client-key.pem ibtmp1 public_key.pem undo_002
binlog.index ib_buffer_pool mysql server-cert.pem
ca-key.pem ibdata1 mysql.ibd server-key.pem
ca.pem ib_logfile0 performance_schema sys
$
</code></pre>
<p>We see that the mysql container has written its files in the folder we shared with it from the host machine.</p>
<p>That&rsquo;s all folks !</p>
<p>You can see this tutorial in action in these video lectures below.</p>
<h3 id="tutorial">Tutorial:</h3>
<p><a href="https://youtu.be/rIxOLB2k-Xc">https://youtu.be/rIxOLB2k-Xc</a></p>
<h3 id="demo">Demo:</h3>
<p><a href="https://youtu.be/YTNpSxY_icw">https://youtu.be/YTNpSxY_icw</a></p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="http://www.ethernetresearch.com/geekzone/kubernetes-tutorial-hands-on/"><i class="fa fa-chevron-circle-left"></i> Kubernetes Tutorial - Hands On For Beginners</a>
        </li>
        
        
        <li>
            <a href="http://www.ethernetresearch.com/geekzone/kubernetes-horizontal-pod-autoscaler-and-metric-server/">Kubernetes Horizontal Pod Autoscaler and Metric Server <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
  
    
    
  





</main>
    <footer>
        <h6>Copyright © 2021 - Ethernet Research | All Rights Reserved.</h6>
    </footer>
</div>
<script src="http://www.ethernetresearch.com/js/scripts.js"></script>


</body>

</html>

