<!doctype html><html lang=en><head><title>Kubernetes Tutorial - How to Install Kubernetes on Ubuntu Baremetal - Ethernet Research</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Ethernet Research: Actionable information about cloud technologies at your fingertips"><meta name=author content="Ganesh Velrajan"><meta property="og:title" content="Kubernetes Tutorial - How to Install Kubernetes on Ubuntu Baremetal"><meta property="og:description" content="The primary goal of this tutorial is teach how to install Kubernetes on Ubuntu and configure a Kubernetes Cluster using a Master and Worker node.
[This is the the first lab in the Kubernetes Tutorial."><meta property="og:type" content="article"><meta property="og:url" content="http://www.ethernetresearch.com/geekzone/kubernetes-tutorial-how-to-install-kubernetes-on-ubuntu/"><meta property="og:image" content="http://www.ethernetresearch.com/images/kubernetes/kubernetes.jpg"><meta property="article:published_time" content="2018-07-19T00:00:00+00:00"><meta property="article:modified_time" content="2018-07-19T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://www.ethernetresearch.com/images/kubernetes/kubernetes.jpg"><meta name=twitter:title content="Kubernetes Tutorial - How to Install Kubernetes on Ubuntu Baremetal"><meta name=twitter:description content="The primary goal of this tutorial is teach how to install Kubernetes on Ubuntu and configure a Kubernetes Cluster using a Master and Worker node.
[This is the the first lab in the Kubernetes Tutorial."><meta name=generator content="Hugo 0.79.1"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=http://www.ethernetresearch.com/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=http://www.ethernetresearch.com/css/styles.css></head><body><div id=container><header><h1><a href=http://www.ethernetresearch.com/>Ethernet Research</a></h1><ul id=social-media><li><a href=https://linkedin.com/in/username title=LinkedIn><i class="fab fa-linkedin fa-lg"></i></a></li><li><a href=https://www.youtube.com/channel/UCnmHCstjZcevizOQ0qmANlw title=Youtube><i class="fab fa-youtube fa-lg"></i></a></li></ul><p><em>Actionable information about cloud technologies</em></p></header><nav><ul><li><a href=http://www.ethernetresearch.com/geekzone/><i class="fa-li fa fa-lg"></i><span>GeekZone</span></a></li><li><a href=http://www.ethernetresearch.com/articles/><i class="fa-li fa fa-lg"></i><span>Articles</span></a></li><li><a href=http://www.ethernetresearch.com/about/><i class="fa-li fa fa-lg"></i><span>About Us</span></a></li><li><a href=http://www.ethernetresearch.com/online-courses-training/><i class="fa-li fa fa-lg"></i><span>Online Courses</span></a></li><li><a href=http://www.ethernetresearch.com/contact/><i class="fa-li fa fa-lg"></i><span>Contact</span></a></li></ul></nav><main><article><h1>Kubernetes Tutorial - How to Install Kubernetes on Ubuntu Baremetal</h1><aside><ul><li><time class=post-date datetime=2018-07-19T00:00:00Z>Jul 19, 2018</time></li><li>Categories:
<em><a href=http://www.ethernetresearch.com/categories/geekzone>GeekZone</a>
,
<a href=http://www.ethernetresearch.com/categories/kubernetes>Kubernetes</a></em></li><li><em><a href=http://www.ethernetresearch.com/tags/container>#Container</a>
,
<a href=http://www.ethernetresearch.com/tags/docker>#Docker</a>
,
<a href=http://www.ethernetresearch.com/tags/kubernetes>#Kubernetes</a></em></li><li>8 minute read</li></ul></aside><div class=featured_image><a href=http://www.ethernetresearch.com/geekzone/kubernetes-tutorial-how-to-install-kubernetes-on-ubuntu/ title="Kubernetes Tutorial - How to Install Kubernetes on Ubuntu Baremetal"><img src=http://www.ethernetresearch.com/images/kubernetes/kubernetes.jpg></a></div><p>The primary goal of this tutorial is teach how to install Kubernetes on Ubuntu and configure a Kubernetes Cluster using a Master and Worker node.</p><p>[This is the the first lab in the Kubernetes Tutorial.]</p><p>The Ubuntu server can be a baremetal Ubuntu server or an Ubuntu VM.  The steps involved are exactly the same.</p><p>Here is the agenda for in this lab.</p><ol><li>Bring up two Ubuntu 16.4 VMs.</li><li>Install and bring up Kubernetes cluster master node,</li><li>Install and bring up Kubernetes cluster worker node,</li><li>Install and bring up Calico CNI.</li><li>Download and run NGINX container.</li><li>Verify NGINX pod runs in the cluster.</li></ol><h2 id=google-cloud-platformgcp>Google Cloud Platform(GCP):</h2><p>I signed up for Google Cloud Platform as it provides a $300 worth of cloud usage for 1 year free.  I you prefer you can also sign up and run this tutorial in GCP.</p><p>Alternatively, you could run the VMs on your laptop.</p><p>I spawned two Ubuntu 16.4 VM&rsquo;s.</p><p>[<em><strong>Please ensure that you use Ubuntu 16.4 for this tutorial.  I tried on 18.4 but I faced several challenges and open bugs in Kubernetes.</strong></em>]{style=&ldquo;text-decoration: underline; color: #ff0000;"}</p><p>[<em><strong>Please ensure that each VM has at least 2 Cores and 4GB RAM.</strong></em>]{style=&ldquo;text-decoration: underline; color: #ff0000;"}</p><h2 id=installing-kubernetes-on-ubuntu>Installing Kubernetes on Ubuntu:</h2><p>The installation procedure is common for both master and worker nodes in a Kubernetes cluster.  Follow the procedure below to install Kubernetes in both the Ubuntu VM&rsquo;s you have spawned.</p><pre><code>Welcome to Ubuntu 16.04.4 LTS (GNU/Linux 4.13.0-1019-gcp x86_64)

* Documentation: https://help.ubuntu.com
 * Management: https://landscape.canonical.com
 * Support: https://ubuntu.com/advantage

Get cloud support with Ubuntu Advantage Cloud Guest:
 http://www.ubuntu.com/business/services/cloud

0 packages can be updated.
0 updates are security updates.




Last login: Sun Jul 8 04:42:10 2018 from 173.194.93.35
master:~$ ifconfig
ens4 Link encap:Ethernet HWaddr 42:01:0a:a0:00:02 
 inet addr:10.160.0.2 Bcast:10.160.0.2 Mask:255.255.255.255
 inet6 addr: fe80::4001:aff:fea0:2/64 Scope:Link
 UP BROADCAST RUNNING MULTICAST MTU:1460 Metric:1
 RX packets:547 errors:0 dropped:0 overruns:0 frame:0
 TX packets:499 errors:0 dropped:0 overruns:0 carrier:0
 collisions:0 txqueuelen:1000 
 RX bytes:413630 (413.6 KB) TX bytes:61585 (61.5 KB)

lo Link encap:Local Loopback 
 inet addr:127.0.0.1 Mask:255.0.0.0
 inet6 addr: ::1/128 Scope:Host
 UP LOOPBACK RUNNING MTU:65536 Metric:1
 RX packets:0 errors:0 dropped:0 overruns:0 frame:0
 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
 collisions:0 txqueuelen:1000 
 RX bytes:0 (0.0 B) TX bytes:0 (0.0 B)
</code></pre><p>Check if the worker node can be pinged from the master node.  This is key to forming the Kubernetes cluster.</p><pre><code>master:~$ ping 10.160.0.3
PING 10.160.0.3 (10.160.0.3) 56(84) bytes of data.
64 bytes from 10.160.0.3: icmp_seq=1 ttl=64 time=1.48 ms
64 bytes from 10.160.0.3: icmp_seq=2 ttl=64 time=0.273 ms
^C
--- 10.160.0.3 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 0.273/0.877/1.481/0.604 ms
</code></pre><h3 id=docker-installation>Docker Installation:</h3><p>We need to install Docker daemon if we need to use Docker images to run Docker containers.  Remember from previous tutorials that Kubernetes is just an orchestration platform.  It manages Docker and LXC containers.</p><pre><code>master:~$ sudo apt-get update   
</code></pre><p>&& sudo apt-get install -qy docker.io</p><h3 id=setup-kubernetes-apt-repository>Setup Kubernetes apt repository:</h3><p>First we need to download the Kubernetes apt packages from the Kubernetes web site to a local repository.</p><pre><code>master:~$ sudo apt-get update   
</code></pre><p>&& sudo apt-get install -y apt-transport-https<br>&& curl -s <a href=https://packages.cloud.google.com/apt/doc/apt-key.gpg>https://packages.cloud.google.com/apt/doc/apt-key.gpg</a> | sudo apt-key add -</p><pre><code>master-1:~$ echo &quot;deb http://apt.kubernetes.io/ kubernetes-xenial main&quot;   
</code></pre><p>| sudo tee -a /etc/apt/sources.list.d/kubernetes.list<br>&& sudo apt-get update</p><h3 id=install-kubernetes>Install Kubernetes</h3><p>Next install the required Kubernetes packages from the local repo.</p><pre><code>master:~$ sudo apt-get update   
</code></pre><p>&& sudo apt-get install -y<br>kubelet<br>kubeadm<br>kubernetes-cni</p><p>This completes the installation of all the softwares required to setup Kubernetes Cluster and run Docker containers in Kubernetes.</p><h3 id=simple-installation-script>Simple Installation Script</h3><p>For ease of use, I have captured all the commands used so far in a shell script file named <strong><a href=http://ethernetresearch.com/ganesh/kube-install.sh>kube-install.sh</a></strong>.  All you need to do is simply download the shell script and execute &ldquo;<strong>sh  kube-install.sh</strong>&rdquo; as a non-root user.  It will install all the software for you in one shot, without requiring any user intervention.</p><p>Please make sure that the Linux swap is turn off.  Kubernetes requires that all pods/containers always stays in memory and not swapped to the disk.</p><pre><code>master:~$ sudo apt install mount   #install swapoff in mount pkg
master:~$ sudo swapoff --all
master:~$ cat /proc/swaps
Filename Type Size Used Priority
</code></pre><blockquote><p><em>I hope you followed all the above set of steps to install Docker and Kubernetes on the worker node also.  If not, please complete the Kubernetes installation in the worker node before we move on the the next steps.</em></p></blockquote><h2 id=inialize-the-master-node>Inialize the master node:</h2><p>From now on, we execute and manage the clusters and pods from the master node only.  Worker nodes don&rsquo;t can&rsquo;t be used for cluster and pod management.</p><p>Initialalize the master node with the following command.  The default subnet for Calico CNI is 192.168.0.0/16 and Flannel CNI is 10.244.0.0/16.  We&rsquo;ll be using Calico CNI plugin for this example.  Hence we&rsquo;ll set &ldquo;—pod-network-cidr&rdquo; to the Calico subnet.</p><p>Set the &ldquo;—apiserver-advertise-address&rdquo; with the ip address of the master node.</p><pre><code>master:~$ sudo kubeadm init —pod-network-cidr=192.168.0.0/16 —apiserver-advertise-address=10.160.0.2

...

Your Kubernetes master has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

mkdir -p $HOME/.kube
 sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
 sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
 https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of machines by running the following on each node
as root:

kubeadm join 10.160.0.2:6443 --token dg6zhb.naxuxb5wd78tdsqz --discovery-token-ca-cert-hash sha256:af9e87508dc6c2c52b6f51dd88635f2dc9f061dce27368f3ac9913b52522cac3
</code></pre><h3 id=heading></h3><h2 id=setup-container-networking-interfacecni>Setup Container Networking Interface(CNI)</h2><p>As the init logs above says, we need to install and setup the CNI. We&rsquo;ll use the Calico CNI plugin in this example.  We should provide the calico.yaml file from the calico&rsquo;s project website.</p><pre><code>master:~$ kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
</code></pre><p>Usually Pods or Containers are not run in the master node. because master nodes are used for controlling purposes and not for executing the jobs.  But, there is an option to override this to run a single node cluster with just the master node.  The pods will run in the master node itself.   Here is the command to make master node to run the Pods.</p><pre><code>$ kubectl taint nodes --all node-role.kubernetes.io/master-
</code></pre><p>However, if you want to build a real world cluster, then skip the above command and go add the worker nodes as explained below.</p><h2 id=configure-the-worker>Configure the Worker:</h2><p>We need to use the token generated by the master during &ldquo;kubeadm init&rdquo; to join from the worker node.</p><p>In case you lost the token generated by the master node, execute the below command in the master node to make it print again.</p><pre><code>master $ kubeadm token create --print-join-command
kubeadm join 10.148.0.2:6443 --token wdyfoz.k1wr3dcdc7l9bd2n --discovery-token-ca-cert-hash s
ha256:d1fa4f7a5d3a5d9b2ba9d32807906fc16fbc16fad5faf81748289faf800add12
</code></pre><p>Now join the worker node to the cluster.</p><pre><code>worker:~$ sudo kubeadm join 10.160.0.2:6443 --token dg6zhb.naxuxb5wd78tdsqz --discovery-token-ca-cert-hash sha256:af9e87508dc6c2c52b6f51dd88635f2dc9f061dce27368f3ac9913b52522cac3
[preflight] running pre-flight checks
I0708 05:23:27.564762 18132 kernel_validator.go:81] Validating kernel version
I0708 05:23:27.564859 18132 kernel_validator.go:96] Validating kernel config
[discovery] Trying to connect to API Server &quot;10.160.0.2:6443&quot;
[discovery] Created cluster-info discovery client, requesting info from &quot;https://10.160.0.2:6443&quot;
[discovery] Requesting info from &quot;https://10.160.0.2:6443&quot; again to validate TLS against the pinned public key
[discovery] Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server &quot;10.160.0.2:6443&quot;
[discovery] Successfully established connection with API Server &quot;10.160.0.2:6443&quot;
[kubelet] Downloading configuration for the kubelet from the &quot;kubelet-config-1.11&quot; ConfigMap in the kube-system namespace
[kubelet] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;
[kubelet] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;
[preflight] Activating the kubelet service
[tlsbootstrap] Waiting for the kubelet to perform the TLS Bootstrap...
[patchnode] Uploading the CRI Socket information &quot;/var/run/dockershim.sock&quot; to the Node API object &quot;instance-2&quot; as an annotation

This node has joined the cluster:
* Certificate signing request was sent to master and a response
 was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the master to see this node join the cluster.
worker:~$
</code></pre><p>Sometime when you run the above command, it may complain that the &ldquo;ip_vs&rdquo; kernel module is not loaded.  To solve this issue, you may need to do download and the missing kernel modules.</p><pre><code>worker:~$ sudo apt install ip_vs
worker:~$ modprobe ip_vs
</code></pre><p>Also, as mentioned earlier, turn off the Linux swap service before running the above join command, using &ldquo;<em>swapoff -a</em>&rdquo; command.</p><h2 id=verify-if-the-cluster-nodes-are-up-and-running>Verify if the cluster nodes are up and running:</h2><p>Use the &ldquo;kubectl get nodes&rdquo; command to check if worker node was able to talk to the master node and join the cluster.  Verify if both master and worker are ready to run pods.</p><pre><code>master:~$ kubectl get nodes
NAME STATUS ROLES AGE VERSION
instance-1 Ready master 14m v1.11.0
instance-2 NotReady  47s v1.11.0
master:~$ kubectl get nodes
NAME STATUS ROLES AGE VERSION
instance-1 Ready master 15m v1.11.0
instance-2 Ready  1m v1.11.0
</code></pre><p>That&rsquo;s all folks.  We are done with installing Kubernetes on a bare metal server.</p><h3 id=spin-an-nginx-pod-in-the-cluster>Spin an NGINX pod in the cluster</h3><p>We should use the master node to execute any cluster/pod management commands.</p><pre><code>master:~$ kubectl run nginx --image=nginx --port=80
deployment.apps/nginx created
</code></pre><p>Verify that the pod is up and running.</p><pre><code>master:~$ kubectl get pods
NAME READY STATUS RESTARTS AGE
nginx-6f858d4d45-b7nk5 0/1 ContainerCreating 0 7s
master:~$ kubectl get pods
NAME READY STATUS RESTARTS AGE
nginx-6f858d4d45-b7nk5 1/1 Running 0 31s
</code></pre><p>To get more details about the pod, use the &lsquo;kubectl describe&rsquo; command.</p><pre><code>master:~$ kubectl describe pods
Name: nginx-6f858d4d45-b7nk5
Namespace: default
Node: instance-2/10.160.0.3
Start Time: Sun, 08 Jul 2018 05:25:21 +0000
Labels: pod-template-hash=2941480801
 run=nginx
Annotations: 

Status: Running
IP: 192.168.56.1
Controlled By: ReplicaSet/nginx-6f858d4d45
Containers:
 nginx:
 Container ID: docker://90431cb74d4f3e3abf77f3344277ba5679137cfad54a473f56d381d1ad0f3a6d
 Image: nginx
 Image ID: docker-pullable://nginx@sha256:a65beb8c90a08b22a9ff6a219c2f363e16c477b6d610da28fe9cba37c2c3a2ac
 Port: 80/TCP
 Host Port: 0/TCP
 State: Running
 Started: Sun, 08 Jul 2018 05:25:35 +0000
 Ready: True
 Restart Count: 0
 Environment: 
 Mounts:
 /var/run/secrets/kubernetes.io/serviceaccount from default-token-n8l4x (ro)
Conditions:
 Type Status
 Initialized True 
 Ready True 
 ContainersReady True 
 PodScheduled True 
Volumes:
 default-token-n8l4x:
 Type: Secret (a volume populated by a Secret)
 SecretName: default-token-n8l4x
 Optional: false
QoS Class: BestEffort
Node-Selectors: 
Tolerations: node.kubernetes.io/not-ready:NoExecute for 300s
 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
 Type Reason Age From Message
 ---- ------ ---- ---- -------
 Normal Scheduled 38s default-scheduler Successfully assigned default/nginx-6f858d4d45-b7nk5 to instance-2
 Normal Pulling 37s kubelet, instance-2 pulling image &quot;nginx&quot;
 Normal Pulled 25s kubelet, instance-2 Successfully pulled image &quot;nginx&quot;
 Normal Created 24s kubelet, instance-2 Created container
 Normal Started 24s kubelet, instance-2 Started container
</code></pre></article><section class=post-nav><ul><li><a href=http://www.ethernetresearch.com/geekzone/kubernetes-vs-docker/><i class="fa fa-chevron-circle-left"></i>Kubernetes vs Docker Swarm - 5 Major Differences</a></li><li><a href=http://www.ethernetresearch.com/geekzone/how-to-install-ssl-certificate-in-wordpress/>How to Install SSL Certificate in WordPress VM <i class="fa fa-chevron-circle-right"></i></a></li></ul></section></main><footer><h6>Copyright © 2021 - Ethernet Research | All Rights Reserved.</h6></footer></div><script src=http://www.ethernetresearch.com/js/scripts.js></script></body></html>